<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>聊一聊扩展字段设计 | BYTEARCH</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="​工作中我们常常有需求需要加字段,如果数据库数据量比较大,新增字段耗时较长,导致性能下降，甚至出现锁表等问题。">
    <link rel="preload" href="/assets/css/0.styles.d8562eb7.css" as="style"><link rel="preload" href="/assets/js/app.c314f9ee.js" as="script"><link rel="preload" href="/assets/js/6.09e13c8a.js" as="script"><link rel="preload" href="/assets/js/3.40a5a29a.js" as="script"><link rel="preload" href="/assets/js/18.4956fad6.js" as="script"><link rel="prefetch" href="/assets/js/10.d22b012d.js"><link rel="prefetch" href="/assets/js/11.c4a01b9e.js"><link rel="prefetch" href="/assets/js/12.0beb10ee.js"><link rel="prefetch" href="/assets/js/13.5a5aa710.js"><link rel="prefetch" href="/assets/js/14.9c230b88.js"><link rel="prefetch" href="/assets/js/15.d525b472.js"><link rel="prefetch" href="/assets/js/16.8029f07f.js"><link rel="prefetch" href="/assets/js/17.0b69f25b.js"><link rel="prefetch" href="/assets/js/19.6e359b5e.js"><link rel="prefetch" href="/assets/js/20.326d7eec.js"><link rel="prefetch" href="/assets/js/21.01fe1373.js"><link rel="prefetch" href="/assets/js/22.2078e537.js"><link rel="prefetch" href="/assets/js/23.b22c15d3.js"><link rel="prefetch" href="/assets/js/4.3ee86ef9.js"><link rel="prefetch" href="/assets/js/5.3c6be164.js"><link rel="prefetch" href="/assets/js/7.5ba497d8.js"><link rel="prefetch" href="/assets/js/8.d0152445.js"><link rel="prefetch" href="/assets/js/9.a692c7c0.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.fb29f47e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d8562eb7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">BYTEARCH </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">首页</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="nav-item"><a href="/about.html" class="nav-link">关于我</a></li><li class="nav-item"><a href="https://www.github.com/bytearch" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">BYTEARCH </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="/about.html" class="nav-link">关于我</a></li><li class="mobile-nav-item"><a href="https://www.github.com/bytearch" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        聊一聊扩展字段设计
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">bytearch</span> <span itemprop="address">   in Beijing</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-04-23T00:00:00.000Z">
      2020-04-23
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-6958873e><a href="/tag/Java" data-v-6958873e> Java </a></li><li class="post-tag" data-v-6958873e><a href="/tag/架构好文" data-v-6958873e> 架构好文 </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="_1-背景"><a href="#_1-背景" class="header-anchor">#</a> 1. 背景</h2> <p>​		工作中我们常常有需求需要加字段,如果数据库数据量比较大,新增字段耗时较长,导致性能下降，甚至出现锁表等问题。
​     添加扩展字段, 常见的做法有,</p> <ul><li>动态添加字段</li> <li>添加扩展表</li> <li>json方式存储</li> <li>xml方式存储</li></ul> <p>这里我们聊聊基于<em>KV行存储</em>和基于<em>按位存储</em>。</p> <h2 id="_2-基于kv水平存储"><a href="#_2-基于kv水平存储" class="header-anchor">#</a> 2. 基于KV水平存储</h2> <p>场景:例如现在有张订单表,需要新增field_1,field_2 字段,并且以后可能会无限扩展字段</p> <ul><li>kv表结构设计</li></ul> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>kv<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">key</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'存储字段名'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">value</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'存储value'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1'</span> <span class="token keyword">COMMENT</span> <span class="token string">'字段类型: 1: string , 2: json'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span><span class="token keyword">key</span><span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_create_time<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'扩展字段KV表'</span><span class="token punctuation">;</span>
</code></pre></div><p><em>注 :实际场景中会对kv表进行分表/分库, 因为都是id维度,可以按照id 取hash 分表/分库</em></p> <ul><li>代码改造如下</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>        <span class="token comment">//1. 从配置中心获取参数key(这里我就直接写死了)</span>
        <span class="token class-name">String</span> fieldKeys <span class="token operator">=</span> <span class="token string">&quot;field_a,field_b&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fieldKeyArr <span class="token operator">=</span> <span class="token class-name">Splitter</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trimResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">omitEmptyStrings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">splitToList</span><span class="token punctuation">(</span>fieldKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2. 从request中获取需要存储param</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>fieldKeyArr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//3. 获取request中的参数</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> fieldKeyArr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> value <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//4组装扩展字段 </span>
        <span class="token punctuation">}</span>
        <span class="token comment">//5 存储扩展字段</span>
</code></pre></div><ul><li>打通查询接口</li></ul> <p>查询语句如下:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">SELECT</span>  <span class="token keyword">key</span><span class="token punctuation">,</span><span class="token keyword">value</span> <span class="token keyword">FROM</span> order_KV <span class="token keyword">where</span> order_id <span class="token operator">=</span> {order_id} <span class="token operator">and</span> <span class="token keyword">key</span> <span class="token operator">in</span><span class="token punctuation">(</span><span class="token string">'field_a'</span><span class="token punctuation">,</span><span class="token string">'field_b'</span><span class="token punctuation">)</span>
</code></pre></div><p>查询接口我们可以新增返回字段Map(String,String) extData,将扩展字段以map的方式返回,以后新增字段就无需改代码了,只需更改配置中心配置即可。</p> <h2 id="_3-基于按位存储设计"><a href="#_3-基于按位存储设计" class="header-anchor">#</a> 3. 基于按位存储设计</h2> <p>适合场景: 我们经常会有新增字段,并且字段类型为布尔(只有0和1)的场景</p> <p>实现思路: 可以新增一个flag(Long型,64位)字段, 由于二进制位只有0和1,所以我们可以利用这个特性来标识只有0和1场景的字段，最多可以表示64个字段。</p> <p>​    实现方式如下</p> <ul><li>首先定义一个flag实体,定义标志key 和位置</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlagBO</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Attribute</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;key&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Attribute</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;position&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Byte</span> position<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getHexLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">&lt;=</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> position <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//2的n-1次方 二进制位 01 10 100 1000</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0L</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>定义字段枚举(这里也可以从配置中心定义)</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
	&lt;!-- 标志位表 一旦设置 不能更改 --&gt; 
  &lt;!-- 注意需要按照规律设置值固定 设置范围 1&lt;= X &lt;= 64  建议按照顺序设置 --&gt; 
*/</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">OrderFlagEnum</span> <span class="token punctuation">{</span>
    <span class="token function">orderFieldBooleanA</span><span class="token punctuation">(</span><span class="token string">&quot;orderFieldBooleanA&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">orderFieldBooleanB</span><span class="token punctuation">(</span><span class="token string">&quot;orderFieldBooleanB&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> key<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Byte</span> position<span class="token punctuation">;</span>

    <span class="token class-name">OrderFlagEnum</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Byte</span> position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>position <span class="token operator">=</span> position<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//获取flag定义列表</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlagBO</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrderFlagBO</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlagBO</span><span class="token punctuation">&gt;</span></span> flagBOList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderFlagEnum</span> orderFlagEnum <span class="token operator">:</span> <span class="token class-name">OrderFlagEnum</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">FlagBO</span> flagBO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlagBO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flagBO<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span>orderFlagEnum<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            flagBO<span class="token punctuation">.</span><span class="token function">setPosition</span><span class="token punctuation">(</span>orderFlagEnum<span class="token punctuation">.</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
            flagBOList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>flagBO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> flagBOList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>从请求参数中获取字段并且组装成flag</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>  
    <span class="token comment">/**
     * encode flag
     *
     * @param request
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">getFlagFromRequest</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">//获取flag配置</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlagBO</span><span class="token punctuation">&gt;</span></span> orderFlags <span class="token operator">=</span> <span class="token function">getOrderFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderFlags <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>orderFlags<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlagBO</span> orderFlag <span class="token operator">:</span> orderFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> parameter <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span>orderFlag<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNumeric</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>parameter<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    flag <span class="token operator">=</span> flag <span class="token operator">|</span> orderFlag<span class="token punctuation">.</span><span class="token function">getHexLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> flag<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre></div><ul><li>查询的时候我们只需要将flag反解出来即可</li> <li>同样在查询接口可以添加至extData</li></ul> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token comment">/**
     * decode flag
     * @param flag
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">decodeOrderFlag</span><span class="token punctuation">(</span><span class="token class-name">Long</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> flagMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlagBO</span><span class="token punctuation">&gt;</span></span> orderFlags <span class="token operator">=</span> <span class="token function">getOrderFlags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderFlags <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>orderFlags<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlagBO</span> orderFlag <span class="token operator">:</span> orderFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flag <span class="token operator">&amp;</span> orderFlag<span class="token punctuation">.</span><span class="token function">getHexLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> orderFlag<span class="token punctuation">.</span><span class="token function">getHexLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    flagMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>orderFlag<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    flagMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>orderFlag<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> flagMap<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ul><li><p>实际运用中我们会遇到这样的场景,比如更新的时候可能同时有<em>添加</em>和<em>删除</em>的场景,如何处理？</p></li> <li><p>我们可以将 添加 和 删除 操作分类为addFlag 和 subFlag</p></li></ul> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token comment">/**
     * 获取更新标志位
     * addFlag 新增
     * subFlag 删除
     * flagMap 中 value true 为添加 否则为删除
     * @param flagMap
     * @return
     */</span>
    <span class="token keyword">public</span> flagUpdateBO <span class="token function">getUpdateFlagBOByMap</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> flagMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flagUpdateBO flagUpdateBO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">flagUpdateBO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> addFlag <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> subFlag <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">FlagBO</span><span class="token punctuation">&gt;</span></span> flagBOMap <span class="token operator">=</span> <span class="token function">getOrderFlagsMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flagMap <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>flagMap<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> flagMapEntry <span class="token operator">:</span> flagMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//存在</span>
                <span class="token class-name">FlagBO</span> flagBO <span class="token operator">=</span> flagBOMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>flagMapEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>flagBO <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>flagMapEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> flagMapEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">//add flag</span>
                        addFlag <span class="token operator">=</span> addFlag <span class="token operator">|</span> flagBO<span class="token punctuation">.</span><span class="token function">getHexLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        subFlag <span class="token operator">=</span> subFlag <span class="token operator">|</span> flagBO<span class="token punctuation">.</span><span class="token function">getHexLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        flagUpdateBO<span class="token punctuation">.</span><span class="token function">setAddFlag</span><span class="token punctuation">(</span>addFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        flagUpdateBO<span class="token punctuation">.</span><span class="token function">setSubFlag</span><span class="token punctuation">(</span>subFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> flagUpdateBO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>最后更新的sql为:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> order_info <span class="token keyword">set</span> flag <span class="token operator">=</span> <span class="token punctuation">(</span>flag <span class="token operator">|</span> <span class="token comment">#{addFlag}) &amp; (~ #{subFlag})</span>
</code></pre></div><p>​</p> <h2 id="_4-总结"><a href="#_4-总结" class="header-anchor">#</a> 4. 总结</h2> <p>flag和kv对比如下</p> <table><thead><tr><th>类型</th> <th>适合规则</th> <th>存储类型</th></tr></thead> <tbody><tr><td>flag</td> <td>只有0和1两种值的情况</td> <td>0和1</td></tr> <tr><td>kv</td> <td>可以任意值</td> <td>可以存储string 和json</td></tr></tbody></table> <p>相信以上方案可以解决工作上大部分添加字段的需求,如果还有其它比较好的方式欢迎与我探讨。</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1-背景" title="1. 背景">1. 背景</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-基于kv水平存储" title="2. 基于KV水平存储">2. 基于KV水平存储</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3-基于按位存储设计" title="3. 基于按位存储设计">3. 基于按位存储设计</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_4-总结" title="4. 总结">4. 总结</a></div></div></div></div> <footer class="footer" data-v-6ff6859a><div class="footer-left-wrap" data-v-6ff6859a><ul class="contact" data-v-6ff6859a><li class="contact-item" data-v-6ff6859a><a href="https://github.com/bytearch/blog" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-6ff6859a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-6ff6859a><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-6ff6859a></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-6ff6859a><ul class="copyright" data-v-6ff6859a><li class="copyright-item" data-v-6ff6859a><a href="http://www.bytearch.com" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-6ff6859a>Copyright © 2020 浅谈架构 | 京ICP备20016259号-1</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c314f9ee.js" defer></script><script src="/assets/js/6.09e13c8a.js" defer></script><script src="/assets/js/3.40a5a29a.js" defer></script><script src="/assets/js/18.4956fad6.js" defer></script>
  </body>
</html>
