<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>基于openresty开发轻量级,按流量控制的灰度模块 | BYTEARCH</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="基于openresty(nginx+lua) 轻量级灰度方案,支持流量控制!">
    <link rel="preload" href="/assets/css/0.styles.d8562eb7.css" as="style"><link rel="preload" href="/assets/js/app.8c447146.js" as="script"><link rel="preload" href="/assets/js/6.09e13c8a.js" as="script"><link rel="preload" href="/assets/js/3.40a5a29a.js" as="script"><link rel="preload" href="/assets/js/18.b731714c.js" as="script"><link rel="prefetch" href="/assets/js/10.d22b012d.js"><link rel="prefetch" href="/assets/js/11.c4a01b9e.js"><link rel="prefetch" href="/assets/js/12.0beb10ee.js"><link rel="prefetch" href="/assets/js/13.c4e70c03.js"><link rel="prefetch" href="/assets/js/14.a63770e9.js"><link rel="prefetch" href="/assets/js/15.17e54ed0.js"><link rel="prefetch" href="/assets/js/16.255929e7.js"><link rel="prefetch" href="/assets/js/17.b7610026.js"><link rel="prefetch" href="/assets/js/19.007c22c4.js"><link rel="prefetch" href="/assets/js/20.527e448b.js"><link rel="prefetch" href="/assets/js/21.861ec262.js"><link rel="prefetch" href="/assets/js/22.02a9bfbd.js"><link rel="prefetch" href="/assets/js/23.653fd688.js"><link rel="prefetch" href="/assets/js/4.3ee86ef9.js"><link rel="prefetch" href="/assets/js/5.3c6be164.js"><link rel="prefetch" href="/assets/js/7.5ba497d8.js"><link rel="prefetch" href="/assets/js/8.d0152445.js"><link rel="prefetch" href="/assets/js/9.a692c7c0.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.fb29f47e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d8562eb7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">BYTEARCH </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">首页</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="nav-item"><a href="/about.html" class="nav-link">关于我</a></li><li class="nav-item"><a href="https://www.github.com/bytearch" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">BYTEARCH </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="/about.html" class="nav-link">关于我</a></li><li class="mobile-nav-item"><a href="https://www.github.com/bytearch" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        基于openresty开发轻量级,按流量控制的灰度模块
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">bytearch</span> <span itemprop="address">   in Beijing</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-05-10T00:00:00.000Z">
      2020-05-10
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-6958873e><a href="/tag/系统重构系列" data-v-6958873e> 系统重构系列 </a></li><li class="post-tag" data-v-6958873e><a href="/tag/Java" data-v-6958873e> Java </a></li><li class="post-tag" data-v-6958873e><a href="/tag/架构好文" data-v-6958873e> 架构好文 </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="_1-为什么要灰度发布"><a href="#_1-为什么要灰度发布" class="header-anchor">#</a> 1.为什么要灰度发布</h2> <ul><li>解决系统重构老系统向新系统平滑迁移</li> <li>按流量控制灰度,可以降低风险,有问题只影响极少了用户</li></ul> <h2 id="_2-设计思路"><a href="#_2-设计思路" class="header-anchor">#</a> 2.设计思路</h2> <p>首先看看openresty指令执行顺序
<img src="http://storage.bytearch.com/images/openresty.png" alt="openresty"></p> <table><thead><tr><th>指令</th> <th>说明</th></tr></thead> <tbody><tr><td>init_by_lua*</td> <td>初始化 nginx 和预加载 lua(nginx 启动和 reload 时执行)</td></tr> <tr><td>init_worker_by_lua*</td> <td>每个工作进程(worker_processes)被创建时执行，用于启动一些定时任务，比如心跳检查，后端服务的健康检查，定时拉取服务器配置等</td></tr> <tr><td>ssl_certificate_by_lua*</td> <td>对 https 请求的处理，即将启动下游 SSL（https）连接的 SSL 握手时执行，用例：按照每个请求设置 SSL 证书链和相应的私钥，按照 SSL 协议有选择的拒绝请求等</td></tr> <tr><td>set_by_lua*</td> <td>设置 nginx 变量</td></tr> <tr><td>rewrite_by_lua*</td> <td>重写请求（从原生 nginx 的 rewrite 阶段进入），执行内部 URL 重写或者外部重定向，典型的如伪静态化的 URL 重写</td></tr> <tr><td>access_by_lua*</td> <td>处理请求（和 rewrite_by_lua 可以实现相同的功能，从原生 nginx 的 access阶段进入）</td></tr> <tr><td>content_by_lua*</td> <td>执行业务逻辑并产生响应，类似于 jsp 中的 servlet</td></tr> <tr><td>balancer_by_lua*</td> <td>负载均衡</td></tr> <tr><td>header_filter_by_lua*</td> <td>处理响应头</td></tr> <tr><td>body_filter_by_lua*</td> <td>处理响应体</td></tr> <tr><td>log_by_lua*</td> <td>记录访问日志</td></tr></tbody></table> <ul><li>所以我们可以在 rewrite_by_lua* 阶段利用lua开发nginx模块动态路由控制,采用请求计数器,若流量在流控范围内,走新系统,否则走老系统。大致流程图如下:</li></ul> <p><img src="http://storage.bytearch.com/images/gray.jpg" alt="gray"></p> <h2 id="_3-实现代码"><a href="#_3-实现代码" class="header-anchor">#</a> 3.实现代码</h2> <ul><li>灰度配置文件</li></ul> <div class="language-lua extra-class"><pre class="language-lua"><code><span class="token comment">-- Copyright (C) www.bytearch.com (iyw)</span>
<span class="token keyword">local</span> _M <span class="token operator">=</span> <span class="token punctuation">{</span>
    _VERSION <span class="token operator">=</span> <span class="token string">&quot;0.0.2&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">-- 灰度级别 0: 按流量比转发  1: 100%流量转发到新系统  2: 100%流量转发到老系统</span>
<span class="token keyword">local</span> proxy_sys_level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- 流量控制级别 可调整 当 proxy_sys_level = 0 时生效</span>
<span class="token comment">-- 0.01%  new = 1, base = 10000</span>
<span class="token comment">-- 0.1%  new = 1, base = 1000</span>
<span class="token comment">-- 0.1%  new = 1, base = 100</span>
<span class="token comment">-- 10%  new = 10, base = 100</span>
<span class="token comment">-- 100% new = 100, base = 100</span>
<span class="token keyword">local</span> proxy_percent <span class="token operator">=</span> <span class="token punctuation">{</span>
    new <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> base <span class="token operator">=</span> <span class="token number">1000</span>
<span class="token punctuation">}</span>

<span class="token comment">-- 灰度uri配置 此处也可以从配置中心 | redis| 文件 等中获取</span>
<span class="token keyword">local</span> proxy_uri_list <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token string">&quot;/test/api&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">true</span>
<span class="token punctuation">}</span>

<span class="token comment">-- ip白名单 该ip 100%转发到新系统(主要为了方便测试)</span>
<span class="token keyword">local</span> white_ip_list <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">-- &quot;192.168.0.1&quot;</span>
<span class="token punctuation">}</span>
<span class="token comment">-- 100%转发到新系统uri配置 (可能有些接口需要指定转发到新系统)</span>
<span class="token keyword">local</span> must_proxy_new_uri_list <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">-- [&quot;/write&quot;] = true,</span>
<span class="token punctuation">}</span>
<span class="token comment">--old</span>
<span class="token keyword">local</span> old_upstream <span class="token operator">=</span> <span class="token string">&quot;proxy_old&quot;</span>
<span class="token comment">--new</span>
<span class="token keyword">local</span> new_upstream <span class="token operator">=</span> <span class="token string">&quot;proxy_new&quot;</span>

_M<span class="token punctuation">[</span><span class="token string">'proxy_sys_level'</span><span class="token punctuation">]</span> <span class="token operator">=</span> proxy_sys_level
_M<span class="token punctuation">[</span><span class="token string">'proxy_percent'</span><span class="token punctuation">]</span> <span class="token operator">=</span> proxy_percent
_M<span class="token punctuation">[</span><span class="token string">'white_ip_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> white_ip_list
_M<span class="token punctuation">[</span><span class="token string">'must_proxy_new_uri_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> must_proxy_new_uri_list
_M<span class="token punctuation">[</span><span class="token string">'proxy_uri_list'</span><span class="token punctuation">]</span> <span class="token operator">=</span> proxy_uri_list
_M<span class="token punctuation">[</span><span class="token string">'old_upstream'</span><span class="token punctuation">]</span> <span class="token operator">=</span> old_upstream
_M<span class="token punctuation">[</span><span class="token string">'new_upstream'</span><span class="token punctuation">]</span> <span class="token operator">=</span> new_upstream

<span class="token keyword">return</span> _M
</code></pre></div><ul><li>解释一下配置</li></ul> <table><thead><tr><th>配置</th> <th>作用</th> <th>说明</th></tr></thead> <tbody><tr><td>proxy_sys_level</td> <td>全局开关</td> <td>0：开启灰度  1:转发到新系统  2:转发到老系统</td></tr> <tr><td>proxy_percent</td> <td>灰度比例配置</td> <td>new = 1, base = 100 则表示1%流量转发到新系统</td></tr> <tr><td>proxy_uri_list</td> <td>灰度uri配置</td> <td>配置了才会走灰度,否则直接走老系统</td></tr> <tr><td>white_ip_list</td> <td>白名单ip</td> <td>指定走新系统ip</td></tr> <tr><td>must_proxy_new_uri_list</td> <td>白名单uri</td> <td>指定走新系统uri</td></tr></tbody></table> <ul><li>灰度模块开发</li></ul> <div class="language-lua extra-class"><pre class="language-lua"><code>    <span class="token comment">-- Copyright (C) www.bytearch.com (iyw)</span>
    <span class="token keyword">local</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;gray.config&quot;</span><span class="token punctuation">)</span>
    
    <span class="token comment">-- 按流量灰度</span>
    <span class="token keyword">local</span> _M <span class="token operator">=</span> <span class="token punctuation">{</span>
        _VERSION <span class="token operator">=</span> <span class="token string">&quot;0.0.&quot;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">-- request count</span>
    <span class="token keyword">local</span> req_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token keyword">local</span> uri_req_count_map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">_getRequestUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> uri <span class="token operator">=</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">.</span>uri
        <span class="token keyword">return</span> uri
    <span class="token keyword">end</span>
    <span class="token comment">-- write api transmit to new api</span>
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">_isProxyNewMust</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> proxy_new_uri_list <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'must_proxy_new_uri_list'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> proxy_new_uri_list<span class="token punctuation">[</span><span class="token function">_getRequestUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> <span class="token keyword">true</span>
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">_checkWhiteReq</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> headers <span class="token operator">=</span> ngx<span class="token punctuation">.</span>req<span class="token punctuation">.</span><span class="token function">get_headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> white_ip_list <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'white_ip_list'</span><span class="token punctuation">]</span>
        <span class="token keyword">local</span> ip <span class="token operator">=</span> headers<span class="token punctuation">[</span><span class="token string">&quot;X-REAL-IP&quot;</span><span class="token punctuation">]</span> <span class="token keyword">or</span> headers<span class="token punctuation">[</span><span class="token string">&quot;X_FORWARDED_FOR&quot;</span><span class="token punctuation">]</span> <span class="token keyword">or</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">.</span>remote_addr <span class="token keyword">or</span> <span class="token string">&quot;0.0.0.0&quot;</span>
        <span class="token keyword">for</span> _<span class="token punctuation">,</span> v <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>white_ip_list<span class="token punctuation">)</span> <span class="token keyword">do</span>
            <span class="token keyword">if</span> v <span class="token operator">==</span> ip <span class="token keyword">then</span>
                <span class="token keyword">return</span> <span class="token keyword">true</span>
            <span class="token keyword">end</span>
        <span class="token keyword">end</span>
        <span class="token keyword">return</span> <span class="token keyword">false</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">_getReqCnt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        req_count <span class="token operator">=</span> req_count <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">return</span> req_count<span class="token punctuation">;</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">_getReqCountByKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
        <span class="token keyword">local</span> req_count <span class="token operator">=</span> uri_req_count_map<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">if</span> req_count <span class="token operator">==</span> <span class="token keyword">nil</span> <span class="token keyword">then</span>
            req_count <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">end</span>
        uri_req_count_map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> req_count <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">return</span> uri_req_count_map<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">_getUpstreamByUriAndCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> proxy_sys_level <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'proxy_sys_level'</span><span class="token punctuation">]</span>
        <span class="token keyword">local</span> old_upstream <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'old_upstream'</span><span class="token punctuation">]</span>
        <span class="token keyword">local</span> new_upstream <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'new_upstream'</span><span class="token punctuation">]</span>
        <span class="token keyword">local</span> proxy_percent <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'proxy_percent'</span><span class="token punctuation">]</span>
        <span class="token comment">-- system level</span>
        <span class="token keyword">if</span> proxy_sys_level <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> old_upstream
        <span class="token keyword">elseif</span> proxy_sys_level <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">then</span>
            <span class="token keyword">return</span> new_upstream
        <span class="token keyword">else</span>
            <span class="token keyword">if</span> <span class="token function">_checkWhiteReq</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">true</span> <span class="token keyword">then</span>
                <span class="token keyword">return</span> new_upstream
            <span class="token keyword">end</span>
            <span class="token comment">-- write first</span>
            <span class="token keyword">if</span> <span class="token function">_isProxyNewMust</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">true</span> <span class="token keyword">then</span>
                <span class="token keyword">return</span> new_upstream
            <span class="token keyword">end</span>
            <span class="token keyword">local</span> uri <span class="token operator">=</span> <span class="token function">_getRequestUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">-- proxy cantain uri</span>
            <span class="token keyword">local</span> proxy_uri_list <span class="token operator">=</span> config<span class="token punctuation">[</span><span class="token string">'proxy_uri_list'</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> uri <span class="token keyword">and</span> proxy_uri_list<span class="token punctuation">[</span>uri<span class="token punctuation">]</span> <span class="token keyword">then</span>
                <span class="token keyword">local</span> count <span class="token operator">=</span> <span class="token function">_getReqCountByKey</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">%</span> proxy_percent<span class="token punctuation">.</span>base<span class="token punctuation">)</span> <span class="token operator">&lt;</span> proxy_percent<span class="token punctuation">.</span>new <span class="token keyword">then</span>
                    <span class="token keyword">return</span> new_upstream
                <span class="token keyword">end</span>
            <span class="token keyword">end</span>
            <span class="token keyword">return</span> old_upstream
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    
    <span class="token keyword">function</span> _M<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">local</span> upstream <span class="token operator">=</span> <span class="token function">_getUpstreamByUriAndCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ngx<span class="token punctuation">.</span>var<span class="token punctuation">.</span>backend <span class="token operator">=</span> upstream
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> _M
</code></pre></div><h2 id="_4-测试"><a href="#_4-测试" class="header-anchor">#</a> 4.测试</h2> <ul><li>test_old.conf 9001端口</li></ul> <div class="language- extra-class"><pre class="language-text"><code>server{
    listen 9001;
    server_name localhost;
    index index.html index.do;
    access_log logs/index_access.log;
    error_log  logs/index_error.log info;
    charset utf-8;
    default_type 'text/html';

    location ~ /write {
        content_by_lua '
            ngx.say(&quot;old write api&quot;)
        ';
    }

    location ~ /(.*){
        set $proxy_uri $1;
        content_by_lua '
            ngx.say(&quot;&lt;h2&gt; Old Api, uri:&quot;, ngx.var.proxy_uri , &quot;&lt;/h2&gt;&quot;)
        ';
    }
}
</code></pre></div><ul><li>test_new.conf 9002端口</li></ul> <div class="language- extra-class"><pre class="language-text"><code>server{
    listen 9002;
    server_name localhost;
    index index.html index.do;
    access_log logs/index_access.log;
    error_log  logs/index_error.log info;
    charset utf-8;
    default_type 'text/html';

    location ~ /write {
        content_by_lua '
            ngx.say(&quot;new write api&quot;)
        ';
    }

    location ~ /(.*){
        set $proxy_uri $1;
        content_by_lua '
            ngx.say(&quot;&lt;h2&gt; new api, uri:&quot;, ngx.var.proxy_uri, &quot;&lt;/h2&gt;&quot;)
        ';
    }
}
</code></pre></div><ul><li>反向代理 9000端口</li></ul> <div class="language- extra-class"><pre class="language-text"><code>#此处配置新老系统地址
upstream proxy_old {
    server localhost:9001 max_fails=3 fail_timeout=2s;
    keepalive 32;

}
upstream proxy_new {
    server localhost:9002 max_fails=3 fail_timeout=2s;
    keepalive 32;
}
server{
    listen 9000;
    server_name localhost;
    index index.html index.do;
    access_log logs/index_access.log;
    error_log  logs/index_error.log info;
    charset utf-8;
    default_type 'text/html';
    ## 注意: lua_code_cache需要设置为on
    lua_code_cache on;

    location ~* /(.*) {
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection &quot;upgrade&quot;;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_http_version 1.1;
        set $backend &quot;proxy_old&quot;;
        rewrite_by_lua_block  {
              local proxy = require(&quot;gray.proxy&quot;);
              if proxy then
                   proxy.init()
              end
        }
        proxy_pass http://$backend;
    }
}
</code></pre></div><ul><li>更改配置proxy_percent.new = 5,  proxy_percent.base = 100 (即5%流量转发到新系统)</li> <li>启动openresty</li></ul> <div class="language- extra-class"><pre class="language-text"><code>openresty -c /usr/local/openresty/nginx/conf/nginx.conf 
</code></pre></div><p>测试如下
<img src="http://storage.bytearch.com/images/gray_test.png" alt="test"></p> <h2 id="_5-总结"><a href="#_5-总结" class="header-anchor">#</a> 5.总结:</h2> <p>实际场景可能更为复杂,比如可能会根据请求参数灰度策略,这些都可以根据实际很容易情况定制开发。
源代码请移步(https://github.com/bytearch/gray) 欢迎star,谢谢大家!</p></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1-为什么要灰度发布" title="1.为什么要灰度发布">1.为什么要灰度发布</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2-设计思路" title="2.设计思路">2.设计思路</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3-实现代码" title="3.实现代码">3.实现代码</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_4-测试" title="4.测试">4.测试</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_5-总结" title="5.总结:">5.总结:</a></div></div></div></div> <footer class="footer" data-v-6ff6859a><div class="footer-left-wrap" data-v-6ff6859a><ul class="contact" data-v-6ff6859a><li class="contact-item" data-v-6ff6859a><a href="https://github.com/bytearch/blog" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-6ff6859a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-6ff6859a><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-6ff6859a></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-6ff6859a><ul class="copyright" data-v-6ff6859a><li class="copyright-item" data-v-6ff6859a><a href="http://www.bytearch.com" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-6ff6859a>Copyright © 2020 浅谈架构 | 京ICP备20016259号-1</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8c447146.js" defer></script><script src="/assets/js/6.09e13c8a.js" defer></script><script src="/assets/js/3.40a5a29a.js" defer></script><script src="/assets/js/18.b731714c.js" defer></script>
  </body>
</html>
