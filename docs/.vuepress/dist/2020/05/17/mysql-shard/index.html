<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浅谈mysql数据库分库分表那些事 | BYTEARCH</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="mysql水平分库分表落地方案 解决亿级数据存储问题">
    <link rel="preload" href="/assets/css/0.styles.d8562eb7.css" as="style"><link rel="preload" href="/assets/js/app.c314f9ee.js" as="script"><link rel="preload" href="/assets/js/6.09e13c8a.js" as="script"><link rel="preload" href="/assets/js/3.40a5a29a.js" as="script"><link rel="preload" href="/assets/js/22.2078e537.js" as="script"><link rel="prefetch" href="/assets/js/10.d22b012d.js"><link rel="prefetch" href="/assets/js/11.c4a01b9e.js"><link rel="prefetch" href="/assets/js/12.0beb10ee.js"><link rel="prefetch" href="/assets/js/13.5a5aa710.js"><link rel="prefetch" href="/assets/js/14.9c230b88.js"><link rel="prefetch" href="/assets/js/15.d525b472.js"><link rel="prefetch" href="/assets/js/16.8029f07f.js"><link rel="prefetch" href="/assets/js/17.0b69f25b.js"><link rel="prefetch" href="/assets/js/18.4956fad6.js"><link rel="prefetch" href="/assets/js/19.6e359b5e.js"><link rel="prefetch" href="/assets/js/20.326d7eec.js"><link rel="prefetch" href="/assets/js/21.01fe1373.js"><link rel="prefetch" href="/assets/js/23.b22c15d3.js"><link rel="prefetch" href="/assets/js/4.3ee86ef9.js"><link rel="prefetch" href="/assets/js/5.3c6be164.js"><link rel="prefetch" href="/assets/js/7.5ba497d8.js"><link rel="prefetch" href="/assets/js/8.d0152445.js"><link rel="prefetch" href="/assets/js/9.a692c7c0.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.fb29f47e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d8562eb7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">BYTEARCH </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">首页</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="nav-item"><a href="/about.html" class="nav-link">关于我</a></li><li class="nav-item"><a href="https://www.github.com/bytearch" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">BYTEARCH </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li><li class="mobile-nav-item"><a href="/about.html" class="nav-link">关于我</a></li><li class="mobile-nav-item"><a href="https://www.github.com/bytearch" target="_blank" rel="noopener noreferrer" class="nav-link external">GitHub</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        浅谈mysql数据库分库分表那些事
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">bytearch</span> <span itemprop="address">   in Beijing</span></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2020-05-17T00:00:00.000Z">
      2020-05-17
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-6958873e><a href="/tag/系统重构系列" data-v-6958873e> 系统重构系列 </a></li><li class="post-tag" data-v-6958873e><a href="/tag/Java" data-v-6958873e> Java </a></li><li class="post-tag" data-v-6958873e><a href="/tag/架构好文" data-v-6958873e> 架构好文 </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="_1、概述"><a href="#_1、概述" class="header-anchor">#</a> 1、概述</h2> <p>mysql分库分表一般有如下场景</p> <p>1).  垂直分表(将表分为主表和扩展表)
2). 垂直分库(将表按业务归属到不同的库,如订单相关的放到订单库,用户相关的表放到用户库等,这也是我们常说的权限回收其中的一部分)
3). 水平拆表(当数据库整体瓶颈还未到时，少量表到达性能瓶颈)
4). 水平拆库 &amp; 拆表(数据整体性能到达瓶颈,单一写入出现性能瓶颈)</p> <p>其中1，2相对较容易实现,本文重点讲讲水平拆表和水平拆库,以及基于mybatis插件方式实现水平拆分方案落地。</p> <h2 id="_2、水平拆表"><a href="#_2、水平拆表" class="header-anchor">#</a> 2、水平拆表</h2> <p>在<a href="http://blog.bytearch.com/2020/04/23/field-extension/" target="_blank" rel="noopener noreferrer">《聊一聊扩展字段设计》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 一文中有讲解到基于KV水平存储扩展字段方案,这就是非常典型的可以水平分表的场景。主表和kv表是一对N关系,随着主表数据量增长,KV表最大N倍线性增长。</p> <p>这里我们以分KV表水平拆分为场景</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>kv<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">key</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'存储字段名'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">value</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'存储value'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">type</span><span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1'</span> <span class="token keyword">COMMENT</span> <span class="token string">'字段类型: 1: string , 2: json'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_create_time<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8mb4 <span class="token keyword">COMMENT</span><span class="token operator">=</span><span class="token string">'订单扩展字段KV表'</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_1-确定shardingkey"><a href="#_1-确定shardingkey" class="header-anchor">#</a> 1. 确定shardingKey</h5> <p>对于kv扩展字段查询,只会根据id + key 或者 id 为条件的方式查询,所以这里我们可以按照id 分片即可</p> <h5 id="_2-确定拆分表数量"><a href="#_2-确定拆分表数量" class="header-anchor">#</a> 2. 确定拆分表数量</h5> <p>分512张表(实际场景具体分多少表还得根据字段增加的频次而定)</p> <p>分表后表名为kv_000  ~  kv_511</p> <p>id % 512 = 1 .... 分到 kv_001,</p> <p>id % 512 = 2 .... 分到 kv_002</p> <p>依次类推!</p> <h5 id="_3-水平分表思路"><a href="#_3-水平分表思路" class="header-anchor">#</a> 3. 水平分表思路</h5> <h6 id="先看看未拆分前sql语句"><a href="#先看看未拆分前sql语句" class="header-anchor">#</a> 先看看未拆分前sql语句</h6> <ol><li>insert</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> kv<span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">key</span><span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">,</span>create_time<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;domain&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;www.bytearch.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-05-17 00:00:00&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>select</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> id<span class="token punctuation">,</span> <span class="token keyword">key</span><span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">,</span>create_time<span class="token punctuation">,</span><span class="token keyword">type</span> <span class="token keyword">from</span> kv <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token keyword">key</span> <span class="token operator">=</span> <span class="token string">&quot;domain&quot;</span><span class="token punctuation">;</span>
</code></pre></div><h6 id="我们可以通过动态更改sql语句表名-拆分后sql语句"><a href="#我们可以通过动态更改sql语句表名-拆分后sql语句" class="header-anchor">#</a> 我们可以通过动态更改sql语句表名,拆分后sql语句</h6> <ol><li>insert</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> kv_001 <span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">key</span><span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">,</span>create_time<span class="token punctuation">,</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;domain&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;www.bytearch.com&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2020-05-17 00:00:00&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>select</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> id<span class="token punctuation">,</span> <span class="token keyword">key</span><span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">,</span>create_time<span class="token punctuation">,</span><span class="token keyword">type</span> <span class="token keyword">from</span> kv_001 <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">and</span> <span class="token keyword">key</span> <span class="token operator">=</span> <span class="token string">&quot;domain&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p>水平分表相对比较容易,后面会讲到基于mybatis插件实现方案</p> <h2 id="_3、水平拆库"><a href="#_3、水平拆库" class="header-anchor">#</a> 3、水平拆库</h2> <p>场景:以下我们基于博客文章表分库场景来分析</p> <p>目标:</p> <ol><li><p>分成1024张库, 000-511号库共用数据节点node1(一个数据节点保护一主多从数据源), 512~1023号库用数据节点node2</p></li> <li><p>支持读写分离</p></li></ol> <p>表结构如下(节选部分字段):</p> <div class="language-sql extra-class"><pre class="language-sql"><code> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">`</span>article<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'文章id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'作者id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'1'</span> <span class="token keyword">COMMENT</span> <span class="token string">'文章状态 -1: 删除 1:草稿 2:已发布'</span> <span class="token punctuation">,</span>
  <span class="token punctuation">`</span>create_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>update_time<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_create_time<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_user_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>idx_status<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token keyword">COMMENT</span> <span class="token string">'订单信息表'</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="_1-确定shardingkey-2"><a href="#_1-确定shardingkey-2" class="header-anchor">#</a> 1)确定shardingKey</h5> <p>按照user_id sharding</p> <h5 id="_2-确定分库数量"><a href="#_2-确定分库数量" class="header-anchor">#</a> 2) 确定分库数量</h5> <p>假如分1024个库,按照user_id % 1024 hash</p> <p>user_id % 1024 = 1  分到db_001库</p> <p>user_id % 1024 = 2 分到db_002库</p> <p>依次类推</p> <h4 id="_3-架构图如下"><a href="#_3-架构图如下" class="header-anchor">#</a> 3) 架构图如下</h4> <p><img src="http://storage.bytearch.com/images/sharding_db.jpg" alt="架构图"></p> <h5 id="_4-性能线性增长"><a href="#_4-性能线性增长" class="header-anchor">#</a> 4) 性能线性增长</h5> <p>目前是2个节点,假如后期达到瓶颈,我们可以增加至4个节点</p> <p><img src="http://storage.bytearch.com/images/sharding_db_4.jpg" alt="sharding_db_4"></p> <p>最多可以增加只1024个节点,性能线性增长</p> <h5 id="_5-非shardingkey查询问题"><a href="#_5-非shardingkey查询问题" class="header-anchor">#</a> 5) 非shardingKey查询问题</h5> <p>对于水平分表/分库后,非shardingKey查询首先得考虑到</p> <ul><li>基因法: 见<a href="http://blog.bytearch.com/2020/05/12/sequenceid/" target="_blank" rel="noopener noreferrer">《分布式唯一id生成器最佳实践》<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 通过主键id可以直接定位到对应库号</li> <li>映射表法: 可以建一张mapping表关联,但是这样引入了额外的单点问题</li> <li>冗余法: 相同数据按照另外一个字段冗余一张表</li> <li>nosql法: 将全量数据存到ES,查询ES</li></ul> <h2 id="_4、基于mybatis插件水平分库分表"><a href="#_4、基于mybatis插件水平分库分表" class="header-anchor">#</a> 4、基于mybatis插件水平分库分表</h2> <p>基于mybatis分库分表,一般常用的一种是基于spring AOP方式, 另外一种基于mybatis插件。其实两种方式思路差不多。</p> <h5 id="基于mybatis分库得首先解决如下问题"><a href="#基于mybatis分库得首先解决如下问题" class="header-anchor">#</a> 基于mybatis分库得首先解决如下问题</h5> <ul><li><p>1). 如何根据shardingKey选择不同的数据源</p></li> <li><p>2). 在哪个阶段切换数据源</p></li> <li><p>3). 在哪个阶段 更改sql语句(也就是需要更改库名&amp;表名, 解决了问题1和问题2,问题3就很容易解决了)</p></li></ul> <h5 id="问题1-使用spring的abstractroutingdatasource进行数据源的动态切换-原理是使用threadlocal先存储数据源key-等需要的的时候获取。"><a href="#问题1-使用spring的abstractroutingdatasource进行数据源的动态切换-原理是使用threadlocal先存储数据源key-等需要的的时候获取。" class="header-anchor">#</a> 问题1: 使用Spring的AbstractRoutingDataSource进行数据源的动态切换,原理是使用ThreadLocal先存储数据源key,等需要的的时候获取。</h5> <h5 id="问题2-这个问题得先分析一下mybatis四大类和插件执行流程-也就是找出也就是分析executor-和statementhandler哪个在获取属于源之前执行"><a href="#问题2-这个问题得先分析一下mybatis四大类和插件执行流程-也就是找出也就是分析executor-和statementhandler哪个在获取属于源之前执行" class="header-anchor">#</a> 问题2: 这个问题得先分析一下mybatis四大类和插件执行流程,也就是找出也就是分析Executor 和StatementHandler哪个在获取属于源之前执行</h5> <p><img src="http://storage.bytearch.com/images/mybatis_plugin_4.jpg" alt="mybatis插件四大类"></p> <p>为了比较直观解决这个问题,我分别在Executor 和StatementHandler阶段2个拦截器</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>plugin</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor<span class="token punctuation">.</span>statement</span><span class="token punctuation">.</span><span class="token class-name">StatementHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>plugin</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql</span><span class="token punctuation">.</span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author bytearch
 */</span>
<span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">StatementHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                method <span class="token operator">=</span> <span class="token string">&quot;prepare&quot;</span><span class="token punctuation">,</span>
                args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">Connection</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StatementHandlerTestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;statementHander执行阶段&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">StatementHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>plugin</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor</span><span class="token punctuation">.</span><span class="token class-name">Executor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>mapping</span><span class="token punctuation">.</span><span class="token class-name">MappedStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>plugin</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session</span><span class="token punctuation">.</span><span class="token class-name">ResultHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session</span><span class="token punctuation">.</span><span class="token class-name">RowBounds</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Properties</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * @author bytearch
 */</span>
<span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">RowBounds</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExecutorHandlerTestInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Executor执行阶段 &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">Executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实现动态数据源获取接口</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>configuration</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>datasource<span class="token punctuation">.</span>lookup</span><span class="token punctuation">.</span><span class="token class-name">AbstractRoutingDataSource</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author yarw
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DynamicDatasource</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutingDataSource</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Object</span> <span class="token function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[获取datasourceKey:{}]&quot;</span><span class="token punctuation">,</span> <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">getDataSourceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">getDataSourceKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


</code></pre></div><p>测试结果如下</p> <p><img src="http://storage.bytearch.com/images/excutorProcess.jpg" alt="测试结果"></p> <p>由此可知,我们需要在Executor阶段 切换数据源</p> <h5 id="问题3-可以在executor切换完数据库完成之后-更改sql-或者在statementhandler阶段更改sql"><a href="#问题3-可以在executor切换完数据库完成之后-更改sql-或者在statementhandler阶段更改sql" class="header-anchor">#</a> 问题3: 可以在Executor切换完数据库完成之后, 更改sql, 或者在StatementHandler阶段更改sql</h5> <p>对于分库:</p> <p>原始sql:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> article<span class="token punctuation">(</span>id<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">)</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">201333425976180992</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2020-05-17 00:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2020-05-17 00:00:00'</span><span class="token punctuation">)</span>
</code></pre></div><p>目标sql:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> ba_test_001<span class="token punctuation">.</span>article <span class="token punctuation">(</span>id<span class="token punctuation">,</span> user_id<span class="token punctuation">,</span> <span class="token keyword">status</span><span class="token punctuation">,</span>create_time<span class="token punctuation">,</span>update_time<span class="token punctuation">)</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">201333425976180992</span>L<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2020-05-17 00:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2020-05-17 00:00:00'</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="完整插件如下"><a href="#完整插件如下" class="header-anchor">#</a> 完整插件如下</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>plugin</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span>DB<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">ShardingBy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">UseMaster</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>common</span><span class="token punctuation">.</span><span class="token class-name">NodeNameEnum</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>configuration</span><span class="token punctuation">.</span><span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>exception</span><span class="token punctuation">.</span><span class="token class-name">ShardingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy</span><span class="token punctuation">.</span><span class="token class-name">IDatabaseShardingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy</span><span class="token punctuation">.</span><span class="token class-name">IShardingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy</span><span class="token punctuation">.</span><span class="token class-name">ITableShardingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy</span><span class="token punctuation">.</span><span class="token class-name">ShardingStrategyUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>executor</span><span class="token punctuation">.</span><span class="token class-name">Executor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>mapping</span><span class="token punctuation">.</span><span class="token class-name">BoundSql</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>mapping</span><span class="token punctuation">.</span><span class="token class-name">MappedStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>mapping</span><span class="token punctuation">.</span><span class="token class-name">SqlCommandType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>mapping</span><span class="token punctuation">.</span><span class="token class-name">SqlSource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>plugin</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session</span><span class="token punctuation">.</span><span class="token class-name">ResultHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>session</span><span class="token punctuation">.</span><span class="token class-name">RowBounds</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">Annotation</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect</span><span class="token punctuation">.</span><span class="token class-name">Field</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect</span><span class="token punctuation">.</span><span class="token class-name">Method</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Arrays</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author bytearch
 */</span>
<span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">&quot;update&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">&quot;query&quot;</span><span class="token punctuation">,</span> args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">RowBounds</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ResultHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ShardingInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MappedStatement</span> ms <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MappedStatement</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">,</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>UPDATE<span class="token punctuation">,</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>DELETE<span class="token punctuation">,</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>SELECT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getSqlCommandType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 读请求: 默认使用从库</span>
            <span class="token comment">// 写请求(INSERT,UPDATE,DELETE): 使用主库</span>
            <span class="token keyword">boolean</span> useMaster <span class="token operator">=</span> <span class="token operator">!</span><span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span>SELECT<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getSqlCommandType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DB</span> DB <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> methodId <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> className <span class="token operator">=</span> methodId<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> methodId<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> methodName <span class="token operator">=</span> methodId<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>methodId<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//是否使用了分库分表策略</span>
            <span class="token class-name">Class</span> clz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Annotation</span> dbAnno <span class="token operator">=</span> clz<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>DB<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dbAnno <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                DB <span class="token operator">=</span> <span class="token punctuation">(</span>DB<span class="token punctuation">)</span> dbAnno<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>DB <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//方法是否使用了@UseMaster注解 @PartitionBy注解</span>
                <span class="token class-name">String</span> partitionName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Method</span> declaredMethod <span class="token operator">:</span> clz<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>declaredMethod<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>methodName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>declaredMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">UseMaster</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        useMaster <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">ShardingBy</span> shardingByAnno <span class="token operator">=</span> declaredMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ShardingBy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>shardingByAnno <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        partitionName <span class="token operator">=</span> shardingByAnno<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>DB <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ShardingException</span><span class="token punctuation">(</span><span class="token string">&quot;error! must @DB on :{}&quot;</span><span class="token punctuation">,</span> clz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token comment">//记录sql是否需要改变</span>
                <span class="token keyword">boolean</span> sqlNeedChanged <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token class-name">Object</span> partitionKey <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> schema <span class="token operator">=</span> DB<span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> tableName <span class="token operator">=</span> DB<span class="token punctuation">.</span><span class="token function">tableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//获取partition</span>
                <span class="token class-name">Object</span> pa <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//params中获取partitionKey</span>
                    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> pa<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>partitionName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        partitionKey <span class="token operator">=</span> paMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>partitionName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pa <span class="token keyword">instanceof</span> <span class="token class-name">Object</span> <span class="token operator">&amp;&amp;</span> partitionKey <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">//Bean对象中获取partitionKey</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Field</span> declaredField <span class="token operator">:</span> pa<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">ShardingBy</span> annotation <span class="token operator">=</span> declaredField<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">ShardingBy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            declaredField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            partitionKey <span class="token operator">=</span> declaredField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>partitionKey <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;获取到shardingKey:{}]&quot;</span><span class="token punctuation">,</span> partitionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//权重 分库 &lt; 分表 &lt; 分库分表(原则上同一Mapper策略只配置一种,如果配置多种依次覆盖)</span>
                    <span class="token comment">//分库</span>
                    <span class="token class-name">IDatabaseShardingStrategy</span> databaseShardingStrategy <span class="token operator">=</span> <span class="token class-name">ShardingStrategyUtils</span><span class="token punctuation">.</span><span class="token function">getDatabaseShardingStrategy</span><span class="token punctuation">(</span>DB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>databaseShardingStrategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        schema <span class="token operator">=</span> databaseShardingStrategy<span class="token punctuation">.</span><span class="token function">getSchemaName</span><span class="token punctuation">(</span>DB<span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        databaseShardingStrategy<span class="token punctuation">.</span><span class="token function">changeDatasourceByPartitionKey</span><span class="token punctuation">(</span>partitionKey<span class="token punctuation">,</span> useMaster<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sqlNeedChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//分表</span>
                    <span class="token class-name">ITableShardingStrategy</span> <span class="token class-name">ITableShardingStrategy</span> <span class="token operator">=</span> <span class="token class-name">ShardingStrategyUtils</span><span class="token punctuation">.</span><span class="token function">getTableShardingStrategy</span><span class="token punctuation">(</span>DB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ITableShardingStrategy</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        tableName <span class="token operator">=</span> <span class="token class-name">ITableShardingStrategy</span><span class="token punctuation">.</span><span class="token function">getTargetTable</span><span class="token punctuation">(</span>DB<span class="token punctuation">.</span><span class="token function">tableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sqlNeedChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token class-name">NodeNameEnum</span> nodeNameEnum <span class="token operator">=</span> <span class="token class-name">NodeNameEnum</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>DB<span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeNameEnum <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">useDataSourceByNodeNum</span><span class="token punctuation">(</span>nodeNameEnum<span class="token punctuation">,</span> useMaster<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//分库分表</span>
                    <span class="token class-name">IShardingStrategy</span> shardingStategy <span class="token operator">=</span> <span class="token class-name">ShardingStrategyUtils</span><span class="token punctuation">.</span><span class="token function">getShardingStategy</span><span class="token punctuation">(</span>DB<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>shardingStategy <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        schema <span class="token operator">=</span> shardingStategy<span class="token punctuation">.</span><span class="token function">getSchemaName</span><span class="token punctuation">(</span>DB<span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        tableName <span class="token operator">=</span> shardingStategy<span class="token punctuation">.</span><span class="token function">getTargetTable</span><span class="token punctuation">(</span>DB<span class="token punctuation">.</span><span class="token function">tableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> partitionKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        databaseShardingStrategy<span class="token punctuation">.</span><span class="token function">changeDatasourceByPartitionKey</span><span class="token punctuation">(</span>partitionKey<span class="token punctuation">,</span> useMaster<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        sqlNeedChanged <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">//不分库也不分表</span>
                    <span class="token class-name">NodeNameEnum</span> nodeNameEnum <span class="token operator">=</span> <span class="token class-name">NodeNameEnum</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>DB<span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeNameEnum <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">DynamicDataSourceContextHolder</span><span class="token punctuation">.</span><span class="token function">useDataSourceByNodeNum</span><span class="token punctuation">(</span>nodeNameEnum<span class="token punctuation">,</span> useMaster<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>sqlNeedChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> ms<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> originSql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[原始SQL] sql:{}&quot;</span><span class="token punctuation">,</span> originSql<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">String</span> sql <span class="token operator">=</span> originSql<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span>DB<span class="token punctuation">.</span><span class="token function">tableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> schema <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> tableName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[更改SQL] sql:{}&quot;</span><span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">BoundSql</span> boundSqlNew <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoundSql</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sql<span class="token punctuation">,</span> boundSql<span class="token punctuation">.</span><span class="token function">getParameterMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> boundSql<span class="token punctuation">.</span><span class="token function">getParameterObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">MappedStatement</span> mappedStatement <span class="token operator">=</span> <span class="token function">copyFromMappedStatement</span><span class="token punctuation">(</span>ms<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BoundSqlSqlSource</span><span class="token punctuation">(</span>boundSqlNew<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> mappedStatement<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>target <span class="token keyword">instanceof</span> <span class="token class-name">Executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">MappedStatement</span> <span class="token function">copyFromMappedStatement</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> ms<span class="token punctuation">,</span> <span class="token class-name">SqlSource</span> newSqlSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token class-name">Builder</span> builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token class-name">Builder</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> newSqlSource<span class="token punctuation">,</span> ms<span class="token punctuation">.</span><span class="token function">getSqlCommandType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">resource</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">fetchSize</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getFetchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">statementType</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getStatementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">keyGenerator</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getKeyGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getKeyProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> ms<span class="token punctuation">.</span><span class="token function">getKeyProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            builder<span class="token punctuation">.</span><span class="token function">keyProperty</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getKeyProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        builder<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">parameterMap</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">resultMaps</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getResultMaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">resultSetType</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getResultSetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">cache</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">getCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">flushCacheRequired</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">isFlushCacheRequired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        builder<span class="token punctuation">.</span><span class="token function">useCache</span><span class="token punctuation">(</span>ms<span class="token punctuation">.</span><span class="token function">isUseCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BoundSqlSqlSource</span> <span class="token keyword">implements</span> <span class="token class-name">SqlSource</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">BoundSqlSqlSource</span><span class="token punctuation">(</span><span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>boundSql <span class="token operator">=</span> boundSql<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">BoundSql</span> <span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> boundSql<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>其中定义了三个注解</p> <p>@useMaster 是否强制读主</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">UseMaster</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre></div><p>@shardingBy 分片标识</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 *
 * @ShardingBy作用于方法 和 Bean属性  优先级 方法 &gt; 属性
 * @author yarw
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>FIELD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">ShardingBy</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 指定分片参数
     * @return
     */</span>
    <span class="token class-name">String</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">ShardingConstant</span><span class="token punctuation">.</span>DEFAULT_PARTITION_KEY_NAME<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>@DB 定义逻辑表名 库名以及分片策略</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>annotation</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy</span><span class="token punctuation">.</span><span class="token class-name">IDatabaseShardingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy</span><span class="token punctuation">.</span><span class="token class-name">IShardingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy</span><span class="token punctuation">.</span><span class="token class-name">ITableShardingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>impl</span><span class="token punctuation">.</span><span class="token class-name">NotUseDatabaseShardingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>impl</span><span class="token punctuation">.</span><span class="token class-name">NotUseShardingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>strategy<span class="token punctuation">.</span>impl</span><span class="token punctuation">.</span><span class="token class-name">NotUseTableShardingStrategy</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment">/**
 * @author yarw
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">,</span> <span class="token class-name">ElementType</span><span class="token punctuation">.</span>TYPE<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Documented</span>
<span class="token annotation punctuation">@Inherited</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> DB <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 分表切分策略
     *
     * @return
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ITableShardingStrategy</span><span class="token punctuation">&gt;</span></span> <span class="token function">tableShardingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">NotUseTableShardingStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 分库切分策略
     *
     * @return
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">IDatabaseShardingStrategy</span><span class="token punctuation">&gt;</span></span> <span class="token function">databaseShardingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">NotUseDatabaseShardingStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 分库&amp;分表切分策略
     * @return
     */</span>
    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">IShardingStrategy</span><span class="token punctuation">&gt;</span></span> <span class="token function">shardingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">NotUseShardingStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 逻辑表名
     *
     * @return
     */</span>
    <span class="token class-name">String</span> <span class="token function">tableName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 逻辑库名
     *
     * @return
     */</span>
    <span class="token class-name">String</span> <span class="token function">schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="测试走一波"><a href="#测试走一波" class="header-anchor">#</a> 测试走一波</h4> <p>1)编写entity</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>entity</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Date</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>bytearch<span class="token punctuation">.</span>mybatis<span class="token punctuation">.</span>sharding<span class="token punctuation">.</span>annotation</span><span class="token punctuation">.</span><span class="token class-name">ShardingBy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> lombok<span class="token punctuation">.</span><span class="token class-name">Data</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Article</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 文章id
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 作者id
     * 可以在此处通过注解指定shardingKey
     */</span>
    <span class="token annotation punctuation">@ShardingBy</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> userId<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 文章状态 -1: 删除 1:草稿 2:已发布
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Byte</span> status<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>编写mapper</li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * @author yarw
 */</span>
<span class="token annotation punctuation">@DB</span><span class="token punctuation">(</span>databaseShardingStrategy <span class="token operator">=</span> <span class="token class-name">LongHashDatabasePartitionStrategy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> schema <span class="token operator">=</span> <span class="token string">&quot;blog&quot;</span><span class="token punctuation">,</span> tableName <span class="token operator">=</span> <span class="token string">&quot;article&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ArticleShardingMapper</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
    * 也可以通过参数指定shardingKey参数
    */</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;select * from article where id = #{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ShardingBy</span><span class="token punctuation">(</span><span class="token string">&quot;shardingKey&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">Article</span> <span class="token function">selectById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;shardingKey&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> shardingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">&quot;insert into article (id, user_id, status,create_time,update_time) value(#{id}, #{userId}, #{status}, #{createTime}, #{updateTime})&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">Article</span> kv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>编写测试类</li></ol> <div class="language-JAVA extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insertArticleTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Article</span> article <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Article</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Long</span> userId <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
        article<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token class-name">SeqIdUtil</span><span class="token punctuation">.</span><span class="token function">nextId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        article<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        article<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        article<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        article<span class="token punctuation">.</span><span class="token function">setUpdateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        articleShardingMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">selectArticleTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Article</span> article <span class="token operator">=</span> articleShardingMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span><span class="token number">201364919411081472L</span><span class="token punctuation">,</span> <span class="token class-name">SeqIdUtil</span><span class="token punctuation">.</span><span class="token function">decodeId</span><span class="token punctuation">(</span><span class="token number">201364919411081472L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtraId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><ol start="4"><li>测试结果</li></ol> <p>Insert</p> <p><img src="http://storage.bytearch.com/images/article_insert_test.png" alt="insert()"></p> <p>select</p> <p><img src="http://storage.bytearch.com/images/article_select_test.png" alt="query"></p> <p>以上顺利实现mysql分库,同样的道理实现同时分库分表也很容易实现。</p> <p>此插件具体实现方案已开源: https://github.com/bytearch/mybatis-sharding</p> <p>目录如下:</p> <div class="language- extra-class"><pre class="language-text"><code>.
├── bytearch_article.sql
├── mybatis-sharding.iml
├── pom.xml
├── readme.md
├── sharding.sql
├── src
│   ├── main
│   │   ├── java
│   │   │   └── com
│   │   │       └── bytearch
│   │   │           └── mybatis
│   │   │               └── sharding
│   │   │                   ├── ShardingApplication.java
│   │   │                   ├── annotation
│   │   │                   │   ├── DB.java    
│   │   │                   │   ├── ShardingBy.java  //分片标识注解
│   │   │                   │   └── UseMaster.java  //强制读主注解
│   │   │                   ├── common
│   │   │                   │   ├── NodeNameEnum.java
│   │   │                   │   └── ShardingConstant.java
│   │   │                   ├── configuration
│   │   │                   │   ├── DynamicDataSourceContextHolder.java
│   │   │                   │   ├── DynamicDatasource.java
│   │   │                   │   ├── NormalDateSourceConfig.java
│   │   │                   │   ├── ShardingConfiguration.java
│   │   │                   │   └── ShardingDateSourceConfig.java
│   │   │                   ├── dao
│   │   │                   │   ├── KVShardingMapper.java
│   │   │                   │   └── KvShardingMapper.xml
│   │   │                   ├── dto
│   │   │                   │   ├── DataSourceKeyNodeDTO.java
│   │   │                   │   └── DataSourceNodeDTO.java
│   │   │                   ├── entity
│   │   │                   │   └── Kv.java
│   │   │                   ├── exception
│   │   │                   │   └── ShardingException.java
│   │   │                   ├── plugin  //插件
│   │   │                   │   ├── ShardingInterceptor.java
│   │   │                   ├── sequence  //唯一id生成器
│   │   │                   │   ├── IdEntity.java
│   │   │                   │   ├── IpUtil.java
│   │   │                   │   └── SeqIdUtil.java
│   │   │                   └── strategy //策略类 
│   │   │                       ├── IDatabaseShardingStrategy.java
│   │   │                       ├── IShardingStrategy.java
│   │   │                       ├── ITableShardingStrategy.java
│   │   │                       ├── ShardingStrategyUtils.java
│   │   │                       └── impl
│   │   │                           ├── LongHashDatabasePartitionStrategy.java
│   │   │                           ├── LongHashTableShardingStrategy.java
│   │   │                           ├── NotUseDatabaseShardingStrategy.java
│   │   │                           ├── NotUseShardingStrategy.java
│   │   │                           └── NotUseTableShardingStrategy.java
│   │   └── resources
│   │       ├── application.yml
│   │       └── mybatis
│   │           └── mybatis-config.xml
│   └── test
│       └── java
│           └── com
│               └── bytearch
│                   └── mybatis
│                       └── sharding
│                           └── DBApplicationTests.java

</code></pre></div><h2 id="_5、总结"><a href="#_5、总结" class="header-anchor">#</a> 5、总结</h2> <p>mysql分库分表,首先得找到瓶颈在哪里(IO or CPU),是分库还是分表,分多少？不能为了分库分表而拆分。
原则上是尽量先垂直拆分 后 水平拆分。
以上基于mybatis插件分库分表是一种实现思路,还有很多不完善的地方,
例如:</p> <ul><li>目前sql是直接替换的,这里有很大隐患,</li> <li>分库后,跨库事务的如何处理等等
以上仅供参考!有其它思路可以欢迎联系我一起交流.</li></ul></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#_1、概述" title="1、概述">1、概述</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_2、水平拆表" title="2、水平拆表">2、水平拆表</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_3、水平拆库" title="3、水平拆库">3、水平拆库</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_4、基于mybatis插件水平分库分表" title="4、基于mybatis插件水平分库分表">4、基于mybatis插件水平分库分表</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#_5、总结" title="5、总结">5、总结</a></div></div></div></div> <footer class="footer" data-v-6ff6859a><div class="footer-left-wrap" data-v-6ff6859a><ul class="contact" data-v-6ff6859a><li class="contact-item" data-v-6ff6859a><a href="https://github.com/bytearch/blog" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-6ff6859a><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-6ff6859a><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-6ff6859a></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-6ff6859a><ul class="copyright" data-v-6ff6859a><li class="copyright-item" data-v-6ff6859a><a href="http://www.bytearch.com" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-6ff6859a>Copyright © 2020 浅谈架构 | 京ICP备20016259号-1</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c314f9ee.js" defer></script><script src="/assets/js/6.09e13c8a.js" defer></script><script src="/assets/js/3.40a5a29a.js" defer></script><script src="/assets/js/22.2078e537.js" defer></script>
  </body>
</html>
